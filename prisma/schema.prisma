// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Estandarización de valores) ---
enum Rol {
  Administrador
  Supervisor
  Chofer
}

enum EstadoServicio {
  Programado
  EnCurso
  Finalizado
  Cancelado
}

enum EstadoAsistencia {
  Presente
  Ausente
  Justificado
}

enum Severidad {
  Baja
  Media
  Alta
  Critica
}

// Modelo para el "Tenant"
model Empresa {
  id     String @id @default(cuid())
  nombre String

  // Parámetros Operacionales
  toleranciaRetraso   Int    @default(15)
  retencionDatosDias  Int    @default(90)
  factorCO2           Float  @default(2.67)
  
  // ✨ NUEVOS CAMPOS ✨
  ventanaInicio       String @default("06:00") // Formato HH:MM
  ventanaFin          String @default("23:00") // Formato HH:MM

  // ... resto de relaciones ...
  usuarios     User[]
  flota        Bus[]
  choferes     Chofer[]
  paradas      Parada[]
  trabajadores Trabajador[]
  servicios    Servicio[]
  posicionesGPS LogPosicion[]
  asistencias   Asistencia[]
  alertas       Alerta[]
  incidentes    Incidente[]
  auditoriaLogs LogAuditoria[]
}

model User {
  id             String @id @default(cuid())
  email          String 
  name           String
  hashedPassword String
  
  // CAMBIO: Usar Enum en lugar de String
  role           Rol    @default(Supervisor)

  empresaId String
  empresa   Empresa @relation(fields: [empresaId], references: [id])

  auditoriaLogs LogAuditoria[]
  chofer        Chofer? 

  @@unique([email, empresaId])
}

model Bus {
  id        String   @id @default(cuid())
  patente   String   @unique // Ojo: La patente debe ser única globalmente o por empresa? Normalmente global.
  capacidad Int
  proveedor String
  
  empresaId String
  empresa   Empresa  @relation(fields: [empresaId], references: [id])
  
  servicios Servicio[]
}

model Chofer {
  id        String    @id @default(cuid())
  rut       String    // Recomendación: Guardar sin puntos ni guion (ej: 123456789)
  nombre    String
  licencia  String
  contacto  String
  
  empresaId String
  empresa   Empresa   @relation(fields: [empresaId], references: [id])
  
  userId    String?   @unique
  user      User?     @relation(fields: [userId], references: [id]) 
  
  servicios Servicio[]
  incidentes Incidente[]

  @@unique([rut, empresaId])
}

model Parada {
  id        String  @id @default(cuid())
  nombre    String
  lat       Float
  lng       Float
  
  empresaId String
  empresa   Empresa @relation(fields: [empresaId], references: [id])
}

model Trabajador {
  id          String       @id @default(cuid())
  rut         String
  nombre      String
  area        String
  
  empresaId   String
  empresa     Empresa      @relation(fields: [empresaId], references: [id])
  
  asistencias Asistencia[]
}

model Servicio {
  id       String   @id @default(cuid())
  fecha    DateTime
  turno    String
  
  // NOTA: String[] es rápido, pero si necesitas saber la hora estimada
  // de llegada a CADA parada, necesitarías una tabla intermedia "ServicioParada".
  // Para el MVP, String[] está bien.
  paradas  String[] 

  // CAMBIO: Enum
  estado   EstadoServicio @default(Programado)

  empresaId String
  empresa   Empresa  @relation(fields: [empresaId], references: [id])
  
  busId    String
  bus      Bus      @relation(fields: [busId], references: [id])
  
  choferId String
  chofer   Chofer   @relation(fields: [choferId], references: [id])

  // Relaciones con borrado en cascada (si borro el servicio, se borra su historial)
  posicionesGPS LogPosicion[]
  asistencias   Asistencia[]
  alertas       Alerta[]
  incidentes    Incidente[]
  
  @@index([fecha, estado])
}

model LogPosicion {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  lat       Float
  lng       Float
  
  empresaId  String
  empresa    Empresa  @relation(fields: [empresaId], references: [id])
  
  servicioId String
  servicio   Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade) // <--- Cascade

  @@index([servicioId, timestamp])
}

model Asistencia {
  id     String   @id @default(cuid())
  
  // CAMBIO: Enum
  status EstadoAsistencia 
  
  checkIn DateTime? 

  empresaId     String
  empresa       Empresa    @relation(fields: [empresaId], references: [id])
  
  servicioId    String
  servicio      Servicio   @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  
  trabajadorId  String
  trabajador    Trabajador @relation(fields: [trabajadorId], references: [id])

  @@unique([servicioId, trabajadorId])
}

model Alerta {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())
  tipo       String 
  
  // CAMBIO: Enum (opcional, puede ser string si es muy variable)
  severidad  String 
  
  estado     String   @default("Pendiente")
  mensaje    String   @db.Text
  
  empresaId  String
  empresa    Empresa  @relation(fields: [empresaId], references: [id])
  
  servicioId String
  servicio   Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  
  @@index([servicioId, estado])
}

model LogAuditoria {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  accion    String 
  detalles  String?  @db.Text
  ip        String?

  empresaId String
  empresa   Empresa @relation(fields: [empresaId], references: [id])
  
  userId    String
  user      User    @relation(fields: [userId], references: [id])
  
  @@index([userId, accion])
}

model Incidente {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())
  tipo       String 
  nota       String   @db.Text
  urlFoto    String?

  empresaId  String
  empresa    Empresa  @relation(fields: [empresaId], references: [id])
  
  servicioId String
  servicio   Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  
  choferId   String
  chofer     Chofer   @relation(fields: [choferId], references: [id])
  
  @@index([servicioId])
}